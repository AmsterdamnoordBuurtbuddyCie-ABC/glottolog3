# coding=utf-8
"""orphaned ref replacement

Revision ID: 
Revises: 
Create Date: 

"""

# revision identifiers, used by Alembic.
revision = ''
down_revision = ''

import datetime
import json

from alembic import op
import sqlalchemy as sa


def upgrade():
    conn = op.get_bind()
    select_jd = sa.text('SELECT jsondata FROM source WHERE id = :id', conn)
    unlink = [sa.text('DELETE FROM %s WHERE EXISTS '
        '(SELECT 1 FROM source WHERE pk = %s.ref_pk AND id = :id)' % (tab, tab), conn)
        for tab in ('refcountry', 'refdoctype', 'refmacroarea', 'refprovider')]
    isolated = [sa.text('SELECT NOT EXISTS (SELECT 1 FROM %s WHERE EXISTS '
        '(SELECT 1 FROM source WHERE pk = %s.source_pk AND id = :id))' % (tab, tab), conn)
        for tab in ('languagesource', 'valuesetreference')]
    del_ref = sa.text('DELETE FROM ref WHERE EXISTS '
        '(SELECT 1 FROM source WHERE PK = ref.pk AND id = :id)', conn)
    del_source = sa.text('DELETE FROM source WHERE id = :id', conn)
    for id, bibkey, replacement in ID_BIBKEY_REPLACEMENT:
        old_bk, rep_bk = (json.loads(select_jd.scalar(id=_) or '{}').get('bibtexkey')
            for _ in (id, replacement))
        if not (bibkey == old_bk == rep_bk):
            print('skipped %r' % ((id, bibkey, replacement),))
            continue
        for u in unlink:
            u.execute(id=id)
        assert all(i.scalar(id=id) for i in isolated)
        del_ref.execute(id=id)
        del_source.execute(id=id)

    raise NotImplementedError


def downgrade():
    pass


ID_BIBKEY_REPLACEMENT = [  # 237
    ('1041', 'blythe_patha-murriny2010', '300044'),
    ('1707', 'shnukal_torres-strait1985', '951'),
    ('2266', 'kilham-pamulkan-pootchemunka-wolmby_wik-mungkan1986', '27571'),
    ('6142', 'dixon_studies-ergativity1987', '18054'),
    ('9409', '[uk]_bechuanaland-adjacent1971', '106399'),
    ('9511', 'baggioni_dictionnaire-reunionnais1997', '56704'),
    ('9649', 'mcelhanon_terminology-komba1969', '144094'),
    ('10403', 'kumar_hindi-lotha1971', '301764'),
    ('11353', 'dai-zhang-zhang_smallest-nationaliy1989', '90244'),
    ('11427', 'ansre_tonal-ewe1961', '323715'),
    ('11514', 'banerjee_introduction-kharia1894', '303295'),
    ('12292', 'snyman_khoisan-zuhoasi1983', '152745'),
    ('12994', 'salser_phonemics-cubeo1971', '127214'),
    ('13906', 'nzang-bie_zone-mmala1989', '128830'),
    ('14255', 'migliazza_amazon-orinoco1985', '152078'),
    ('14426', 'manus_urarina-rollo1961', '143997'),
    ('14690', 'bosch-poulos_zulu1997', '60703'),
    ('14802', 'bailey_guresi-drasi1924', '314157'),
    ('16802', 'givon_causes-wider1971', '109121'),
    ('16988', 'mcelhanon_phonology-selepet1970', '74176'),
    ('18879', 'pertin_note-nah1992', '304745'),
    ('18981', 'katsura_onso-taikei1968', '18182'),
    ('19459', 'thiesen-thiesen_castellano-bora1998', '10341'),
    ('19656', 'hawkinson_handbook-tanzanian1979', '45880'),
    ('21098', 'lane_understanding-mbete1989', '13538'),
    ('22084', 'shimizu_kente-kpan1971', '135296'),
    ('22169', 'watters-watters_glossary-kham1973', '130040'),
    ('22433', 'weimer-weimer_language-yareba1974', '91689'),
    ('23662', 'peck_mood-casamance1988', '175757'),
    ('26119', 'blench_affinities-tapshin2006', '120649'),
    ('27206', 'metraux_bresil-disparition1962', '46982'),
    ('28113', 'coutu-melancon-prost_buli-latakora1974', '71315'),
    ('28845', 'goldie_grammar-efik1874', '40995'),
    ('29782', 'ngcobe-rycroft_it-say1979', '323231'),
    ('29852', 'salser-salser_sentence-cubeo1977', '54399'),
    ('30156', 'abraham_literature-sound1959', '321189'),
    ('30830', 'hale_causativo-misumalpa1996', '300170'),
    ('32628', 'hansson_khatu-pijo1989', '155349'),
    ('33687', 'curr_leich-ardt1886', '71933'),
    ('35522', 'bieri-hale-schulze_approach-sunwar1973', '83272'),
    ('35648', 'dechaine-manfredi_june-leiden1997', '90814'),
    ('37508', 'tucker_mikea-forager2001', '31311'),
    ('40179', 'kumar_hindi-sema1971', '311741'),
    ('41500', 'shipley-uldall_texts-nisenan1966', '66593'),
    ('42187', 'jacq-sidwell_sapuan-sepuar1999', '16055'),
    ('42708', 'sheldon_mura-perturbation1974', '321887'),
    ('42957', 'blench_affinities-yangkam2006', '42808'),
    ('43046', 'loewen_epera-sambu1958', '74987'),
    ('43370', 'blench_kambari-tsuvadi2007', '97448'),
    ('44924', 'abdullaev_jazyk-darginskij1967', '39570'),
    ('45271', 'mazrui_sheng-slang1995', '51007'),
    ('45402', 'decker_languages-chitral1992', '68751'),
    ('46647', 'kavari-mohlig_herero-otjiherero2008', '46638'),
    ('47234', 'angenot-ferrarezi_descoberta-isolantes1997', '147692'),
    ('47534', 'urban_metaphysical-intellect1996', '34268'),
    ('47911', 'guldemann_khoisan-tuu2005', '124440'),
    ('48261', 'gonzalez_meaning-pampangan1981', '76055'),
    ('50045', 'glover-yadava_topics-nepalese1999', '130814'),
    ('50308', 'hardy-montler-sylestine_dictionary-alabama1993', '146851'),
    ('52543', 'metraux_basin-gathering1948', '101707'),
    ('52563', 'rosas_diccionario-pampa1947', '312142'),
    ('53384', 'salser_bibliografia-cubeo1980', '57663'),
    ('53428', 'johnson_ghana-larteh1973', '49440'),
    ('53484', 'parker_estudios-chamicuro1991', '110589'),
    ('53859', 'dunham_tanzanie-valangi2001', '56029'),
    ('55714', 'bhaskararao_gadaba1998', '25372'),
    ('56017', 'abraham_hausa-people1959', '324529'),
    ('56685', 'metraux_puri-coroado1946', '51852'),
    ('57163', 'holt_paya-pech1999', '49751'),
    ('57935', 'camara_classificacao-brasileiras1959', '113256'),
    ('60102', 'samarin_ideophones-determining1967', '146169'),
    ('60174', 'dunn_practical-tsimshian1978', '321721'),
    ('60356', 'ottaviano-ottaviano_castellano-tacana1989', '309943'),
    ('60718', 'diebold_dispersal-centers1960', '124714'),
    ('61658', 'gabas_brazil-karo1999', '125332'),
    ('62158', 'gudschinsky_xavante-ofaie1971', '54471'),
    ('62947', 'taylor_reading-fulani1921', '35847'),
    ('63128', 'liang_gaikuang-laiyu1984', '321783'),
    ('63307', 'beach_phonetics-hottentot1938', '324673'),
    ('63508', 'urban_shokleng-accusativity1985', '41912'),
    ('64210', 'cyffer_neighbours-meet2006', '39305'),
    ('64854', 'martin_languages2004', '71052'),
    ('65114', 'healey_phonology-telefol1964', '92905'),
    ('65770', 'theraphan_shan-lakkja1992', '11699'),
    ('65877', 'hohenthal_tribos-baixo1960', '147142'),
    ('66990', 'weber_pascua-polinesica2003', '130151'),
    ('67255', 'brownie-brownie_mussau-emira2002', '303921'),
    ('69752', 'mattos_fonemica-xerente1971', '154078'),
    ('70181', 'luce_tibetan-oldburmeseunda', '161157'),
    ('71336', 'metraux_bolivian-slopes1948', '130179'),
    ('71921', 'larrimore-pym_papers-iwaidja1979', '2598'),
    ('72048', 'wang_chinese-ancestry1995', '16372'),
    ('72172', 'ewan-hombert-ohala_tones-explanations1979', '151189'),
    ('72400', 'hall_pidgin-melanesian1943', '175692'),
    ('74936', 'luce_tibetan-burmeseunda', '145652'),
    ('76561', 'y_ecuador-kanar1961', '85827'),
    ('76907', 'lehman_annual-meeting1971', '310725'),
    ('77924', 'salser-salser_fonologia-cubeo1976', '48888'),
    ('78210', 'straube_athiopiens-westkuschitische1963', '72343'),
    ('78220', 'metraux_etnografia-chaquense1944', '40345'),
    ('78975', 'bandhu-caughley-dahal_culture-chepang1971', '124437'),
    ('79276', 'grah_systematique-niwoli1983', '33829'),
    ('80131', 'metraux_jurua-basins1948', '98647'),
    ('80852', 'mahamat_lexicale-mpadi2005', '307403'),
    ('84349', 'hohenthal_araroba-shucuru1954', '163448'),
    ('86145', 'heath_mekaa-nyong1989', '110687'),
    ('86956', 'holzhausen-holzhausen-rai_nepali-kulung1975', '146706'),
    ('88847', 'bright-holt_mesoamerica-paya1976', '136620'),
    ('89836', 'zepeda_grammar-papago1983', '144761'),
    ('90989', 'law_isthmus-nahuat1955', '324193'),
    ('91086', 'salser_cubeo1973', '92596'),
    ('92252', 'blench_affinities-pe2006', '161382'),
    ('93024', 'greenberg_hausa-problems1941', '324376'),
    ('93649', 'goeje_indianen-surinaamsche1906', '164295'),
    ('95878', 'sharma_pattani-lahaul1982', '319358'),
    ('97326', 'berger_sudlichste-nilotensprache1938', '70996'),
    ('98216', 'camara_vocabulos-tipologico1959', '8868'),
    ('98329', 'hall_creole-haitian1953', '175623'),
    ('98370', 'sudlow_faso-tamasheq2001', '9727'),
    ('98436', 'almkvist_bedawie-bischari1881', '132823'),
    ('98463', 'makuya-wentzel-ziervogel_handbook-venda1990', '141207'),
    ('98932', 'bertkau-duitsman-laesch_dialects-kru1975', '118418'),
    ('99548', 'alvarez_dioses-piros1970', '35542'),
    ('100206', 'terescenko_jazyk-nganasanskij1979', '95921'),
    ('101070', 'haupers-haupers_dictionary-stieng1991', '160612'),
    ('101226', 'krishnamurti_konda-kubi1969', '92898'),
    ('101449', 'gabas_karo-arara1989', '82124'),
    ('102079', 'girard_hindi-korku1965', '78468'),
    ('102563', 'hopkins_handbook-setswana1979', '8944'),
    ('103846', 'bista-iijima-ishii-nagano-nishi_nepal-gandaki1982', '132434'),
    ('104965', 'mcelhanon_root-selepet1972', '121598'),
    ('106153', 'hall-mcleod-mitchell_xavante-pequeno1987', '43052'),
    ('106888', 'rassadin_tofalarskogo-sravnitelnom1978', '302126'),
    ('106954', 'bishop-reid_totonaco-xicotepec1974', '82001'),
    ('107322', 'hofmann_nubischen-kenzi1983', '52796'),
    ('107734', 'hanks-hanks-sharp_ethnographic-thailand1965', '163649'),
    ('108084', 'issak_ordbok-norsk1999', '153414'),
    ('108236', 'hallberg-oleary-rensch_hindko-gujari1992', '28930'),
    ('108749', 'parrott-waterhouse_sierra-chontal1970', '16496'),
    ('109313', 'dongzhou-janhunen-peltomaa-sandman_wutun2008', '56080'),
    ('110591', 'seidel_grundzuge-usindja1898', '99660'),
    ('111099', 'pike_tonemic-intonemic1951', '325583'),
    ('111509', 'honsberger-honsberger-tupper_essentials-kwomtari2008', '67136'),
    ('111551', 'haas_thai-writing1956', '325598'),
    ('112035', 'williamson_reconstructions-ijoid2004', '85799'),
    ('113516', 'coiazzi_archipielago-fueguino1914', '102737'),
    ('114235', 'blench_affinities-horom2006', '159709'),
    ('116531', 'knoche_krag-espirito1913', '67439'),
    ('119321', 'henriksen_observaciones-cuaiquer1991', '33249'),
    ('119933', 'blood-blood-y_mnong-rolom1976', '144104'),
    ('123484', 'abasheikh-kisseberth_chi-mwi1974', '48161'),
    ('125128', 'mangulu_mbelo-senggele2001', '59913'),
    ('126372', 'moser-moser_castellano-seri1961', '30637'),
    ('127673', 'lukusa_shiyeyi-groundwork2002', '37220'),
    ('129323', 'barney-smalley_miao-meo1953', '135201'),
    ('129716', 'pike-pike_mazateco-immediate1947', '324857'),
    ('131912', 'berjaoui_moroccan-gus2008', '78745'),
    ('131985', 'sevoroskin_jazyk-lidijskij1967', '306200'),
    ('132128', 'stevenson_otoro-nyiman1956', '323549'),
    ('132462', 'dungca-ogo-topping_dictionary-chamorro1975', '38174'),
    ('132815', 'byarushengo-duranti-hyman_grammatical-haya1977', '156868'),
    ('132826', 'bates-hess-hilbert_dictionary-lushootseed1994', '31549'),
    ('133145', 'segurola_dictionnaire-fon1963', '153951'),
    ('133816', 'boggiani_guana-dellidioma1895', '28802'),
    ('135370', 'salser_gourd-blackening1975', '37889'),
    ('135805', 'uslar_jazyk-cecenskij1888', '38919'),
    ('136308', 'glover-glover_guide-gurung1972', '131379'),
    ('136463', 'salser_acculturation-coca1970', '102638'),
    ('136998', 'kozelka_ewe-togo1980', '37154'),
    ('137436', 'snethlage_chipaya-curuahe1910', '84538'),
    ('138183', 'nurse_kenyas-ilwana1994', '11693'),
    ('142715', 'rennison_koromfe1997', '55813'),
    ('143665', 'harrison-harrison_zoque-rayon1984', '42707'),
    ('143904', 'klingler-marshall-valdmann_creole-louisiana1998', '68065'),
    ('144520', 'parkinson_sudsee-dreissig1907', '316690'),
    ('148249', 'gabas_stock-ramarama2000', '41457'),
    ('149161', 'beavon-beavon_lexique-koonzime1996', '79675'),
    ('149541', 'comrie-keenan_universal-accessibility1977', '176397'),
    ('150140', 'dennis-dennis_jicaque-tol1983', '94813'),
    ('153062', 'ulrich-ulrich_maya-mopan1976', '62349'),
    ('156726', 'camara_nimuendaju-curt1959', '38627'),
    ('157166', 'kiparsky_change-universals1968', '323521'),
    ('157790', 'liang-zhang_hua-biao2002', '51026'),
    ('158572', 'dhall_spoken-orissa1957', '99588'),
    ('158804', 'kirk_proto-mazatec1966', '92322'),
    ('160038', 'pokrovskaja_gagauzskogo-sravnitelnom1978', '301333'),
    ('160768', 'ghatage-kalelkar-krishnamurti-pandit_modern-workbook1962', '128288'),
    ('161449', 'loos-loos_castellano-capanahua1998', '148904'),
    ('164109', 'james_ethnic-hymnody1969', '12842'),
    ('164721', 'carlson-flett_dictionary-spokane1989', '163082'),
    ('165282', 'kaplan_kaplan-qawiaraqnd', '165281'),
    ('171751', 'buschmann_westseite-mexicos1857', '313383'),
    ('174905', 'bossong_aktiven-fundamentalrelation1980', '54696'),
    ('176770', 'omamor_sketch-isekiri1979', '8738'),
    ('176910', 'gebre-tsadik-sim-sim-wedekind-wedekind_highland-burji1985', '70635'),
    ('177846', 'gottschligg_paradis-rezeptionsgeschichte1997', '48416'),
    ('178307', 'bradshaw_jabem-numbami1999', '94225'),
    ('178596', 'lapolla_tibetan-phonetic1988', '43196'),
    ('179359', 'lefebvre_fongbe-clausal1991', '156050'),
    ('180016', 'chen-malambe_siswati-palatalization1998', '59406'),
    ('180411', 'gruere-sardessai_systeme-konkani1998', '136405'),
    ('180413', 'bentolila-shimelis_systeme-lamharique1998', '94238'),
    ('181593', 'noss_ideas-phones2001', '46355'),
    ('182172', 'andenes-beermann-hellan_akan-serial2003', '10033'),
    ('182402', 'bubenik_prakrits-apabhramsa2003', '319602'),
    ('183561', 'murthy-subbarao_telugu-anaphors2000', '13054'),
    ('183564', 'hook-koul-koul-wali_kashmiri-anaphors2000', '140051'),
    ('183568', 'gair-karunatillake_sinhala-anaphors2000', '129653'),
    ('183569', 'murthy-subbarao_anaphors-mizo2000', '43407'),
    ('183570', 'patnaik-subbarao_anaphors-juang2000', '124586'),
    ('183586', 'steever_gondi1998', '141252'),
    ('183975', 'besten-luijks-roberge_afrikaans-reduplication2003', '175442'),
    ('184427', 'phong_quang-nguon1996', '61235'),
    ('185131', 'thompson-thompson_xi-thompson1980', '88156'),
    ('185191', 'campbell-langacker_vowels-aztecan1978', '185195'),
    ('300080', 'franklin_wurm-fascicle1977', '26041'),
    ('300425', 'mohapatra_texts-juang1991', '42763'),
    ('301566', 'mega-purwati-yusuf_jilid-bina2007', '312847'),
    ('302572', 'hahn_grundzuge-westlichen1857', '63447'),
    ('304285', 'ouzilleau_sanga-suivies1911', '82908'),
    ('304370', 'celedon_bintukua-guamaka1886', '303413'),
    ('305196', 'wilson_tirailleur-troops1999', '315590'),
    ('305240', 'bird-tadadjeu_petit-yemba1997', '23983'),
    ('305831', 'blench_affinities-kwang2007', '161236'),
    ('306370', 'voorhoeve_neighbours-makian1982', '68295'),
    ('306391', 'baggioni_dictionnaire-reunionnais1990', '176198'),
    ('308452', 'pinnow_historischen-grundzuge1966', '151995'),
    ('309582', 'luce_kadu-gananunda', '325761'),
    ('309794', 'toral_sociedade-cosmologia1992', '126888'),
    ('309983', 'martinic_geografica-canoeros1989', '115916'),
    ('310176', 'greenberg_family-niger1949', '78293'),
    ('310308', 'jordan_hills-mindat1969', '118687'),
    ('311247', 'stokhof_moluccas-seram1981', '148049'),
    ('311345', 'love_tay-boi2001', '315479'),
    ('311597', 'rongier_index-suivi1995', '57179'),
    ('314010', 'campbell-kaufman_distant-straight1983', '151423'),
    ('320743', 'al-jallad_arabia-hybridity2013', '326141'),
]
